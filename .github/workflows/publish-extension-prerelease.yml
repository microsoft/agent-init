name: Publish Extension Pre-Release

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

permissions:
  contents: read

jobs:
  publish-prerelease:
    name: Publish Pre-Release
    runs-on: ubuntu-latest
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      !contains(github.event.workflow_run.head_commit.message, 'chore(main): release')
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: |
            package-lock.json
            vscode-extension/package-lock.json
      - run: npm ci --ignore-scripts
      - run: npm ci
        working-directory: vscode-extension
      - name: Set pre-release version
        run: npm version 0.0.${{ github.event.workflow_run.run_number }} --no-git-tag-version
        working-directory: vscode-extension
      - name: Build extension
        run: node esbuild.mjs --production
        working-directory: vscode-extension
      - name: Publish pre-release to VS Code Marketplace
        run: npx @vscode/vsce publish --pre-release --no-dependencies
        working-directory: vscode-extension
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
